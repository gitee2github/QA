![openEuler ico](../../images/openEuler.png)

版权所有 © 2020  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期 | 修订   版本 | 修改描述 | 作者 |
| ---- | ----------- | -------- | ---- |
| 2021/03/10 | v1.0 | 添加热迁移加强特性测试报告 | Ganqx |

 关键词： 热迁移加强  TLS多通道热迁移 脏页率查询 测试报告


摘要：本次热迁移加强主要新增了TLS多通道热迁移和脏页率查询两个特性：（1）TLS多通道热迁移能够建立多个传输通道加速TLS热迁移的速度，测试后共发现1个一般问题，已解决，总体质量良好；（2）脏页率统计功能能够估算虚拟机内部脏页产生的速率，帮助用户综合考虑是否进行热迁移，测试后未发现问题，总体质量良好。


缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| TLS | Transport Layer Security | 传输安全层协议 |

# 1     特性概述

- TLS多通道热迁移：为了能够更好的对虚拟机热迁移过程中数据的加密，openEuler提供了使用TLS对迁移数据进行加密的特性。但是在热迁移TLS加密传输过程中，CPU处理加密算法存在瓶颈，网络带宽得不到充分利用。本次新增的TLS多通道热迁移特性利用多CPU优势突破瓶颈，大幅度提高了TLS热迁移的速度。

- 脏页率统计：当虚拟机内部业务压力较大时，脏页产生速率过快，常常会导致热迁移失败，但在宿主机上通常缺少手段获取虚拟机内部脏页产生速率。本次特性提供了一个基于内存采样的方案，能够以极低消耗估算虚拟机内部脏页产生的速率，辅助用户判断当前环境是否适合进行迁移。


# 2     特性测试信息

## 2.1 版本信息：

| 版本名称 | 测试起始时间 | 测试结束时间 |
| -------- | ------------ | ------------ |
| openEuler-21.03 RC1 | 2021/03/01 | 2021/03/05 |

## 2.2 硬件环境信息：

| 硬件型号 | 硬件配置信息 | 备注 |
| -------- | ------------ | ---- |
| TaiShan 2280 V2 | 96U 512G | ARM |
| TaiShan 2288 V5 | 104U 576G | X86 |

# 3     测试结论概述

## 3.1   测试整体结论

### 3.1.1 TLS多通道热迁移：

共计执行28个用例，主要覆盖了接口测试、可靠性测试、性能测试。测试过程中通过经过地址消毒测试，发现1个一般问题，现已解决，回归测试通过，整体质量良好。

| 测试活动 | 活动评价 |
| -------- | -------- |
| 接口测试 | 接受边界值、错误值、默认值后反馈均符合预期 |
| 性能测试 | 在带宽充足的情况下，迁移速度较单通道迁移有明显提升 |
| 可靠性测试 | 并发场景、压力场景中特性能够正常运行，测试过程中发生少量内存泄露 |

### 3.1.2 脏页率统计：

共计执行27个用例，主要覆盖了接口测试、可靠性测试，未发现问题，整体质量良好。

| 测试活动 | 活动评价 |
| -------- | -------- |
| 接口测试 | 接受边界值、错误值、默认值后反馈均符合预期 |
| 可靠性测试 | 并发场景、压力场景、异常场景中特性均能够正常运行，表现稳定 |



## 3.2   约束说明

### 3.2.1 TLS多通道热迁移：

- 源端和目的端CPU型号相同、qemu版本相同且处于同一网段;

- 迁移目的端需要预留虚拟机所需的CPU、内存等资源；

- 源端目的端中除虚拟机资源所需外，有预留足够的空闲CPU用于多通道迁移；

- 源端、目的端均已配置好TLS证书。

### 3.2.2脏页率统计：

无




## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| ------ | ------ | ------ | ------ | ------ |
| https://gitee.com/openeuler/qemu/issues/I3A5VT?from=project-issue | TLS热迁移时产生少量的内存泄露 | 次要 | 造成多余的内存消耗，已合入补丁修复 | 关闭 |



### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | ------ | ------ | ------ | ------ | ------ |
| 数目   | 1 | 0 | 0 | 1 | 0 |
| 百分比 |  | 0 | 0 | 100% | 0 |

# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称 | 测试用例数 | 用例执行结果 | 发现问题单数 |
| -------- | ---------- | ------------ | ------------ |
| openEuler-21.03 RC1 多通道TLS热迁移 | 28 | 27PASS + 1FAIL | 1 |
| openEuler-21.03 RC1 脏页率统计 | 27 | 27PASS | 0 |

*数据项说明：*

*测试用例数－－到本测试活动结束时，所有可用测试用例数；*

*发现问题单数－－本测试活动总共发现的问题单数。*



## 4.2   后续测试建议

- 关注TLS多通道热迁移与后续新增的热迁移特性交互时的情况；

- 关注TLS多通道热迁移在预留资源不足的环境下使用的情况；

- 关注脏页率统计在不同业务压力下的准确度。

# 5     附件

## 5.1 TLS多通道热迁移性能测试数据

- 硬件环境：TaiShan 2280 V2
- OS：openEuler 21.03
- openEuler qemu版本：4.1.0-48
- 虚拟机规格：8U 32G
- 内存脏页压力：4G 256MB/s


|  | 单通道迁移 | 多通道迁移（2通道） | 多通道迁移（4通道） |
| ---- | ---- | ---- | ---- |
| 迁移时间（s） | 22.78 | 14.26 | 12.17 |
