![openEuler ico](../../images/openEuler.png)

版权所有 © 2022  openEuler社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述                                     | 作者 |
| ---------- | ----------- | -------------------------------------------- | ---- |
| 2022/10/29 | v1.0        |                                              | 王丹 |
| 2022/11/15 | v2.0        | 反馈优化bolt-use模式mysql-8.0.20功能测试报告 | 王丹 |


摘要：依据测试要求，对GCC编译器特性进行基础功能测试、GCC二进制反馈优化bolt-use模式进行功能测试。



# 1     特性概述

GCC（GNU Compiler Collection，GNU编译器套件）是由GNU开发的编程语言器。GNU编译器套件包括C、C++、Objective-C、Fortran、java、Ada和Go语言前端，也包括了这些语言的库（如libstdc++，libgcj等。）

反馈优化是一种编译优化方法，能够根据程序的运行行为进行程序性能优化。与其他编译器优化相比，反馈优化的输入不仅仅是源代码文件，还包括程序的运行时数据，编译器能够根据运行数据来指导程序优化。反馈优化通过一系列优化算法增强程序的性能，包括内联、基本块重排、函数重排优化、常量传播、条件分支优化、冷热分区优化等。优化并不改变程序原有逻辑，只改善程序的执行效率。

GCC使用-fbolt-use选项获得profile路径，直接传递给BOLT-Plugin插件。GCC BOLT-Plugin插件直接调用环境变量中BOLT工具，完成reorder-blocks、reorder-functions、split-functions、icf等优化。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                         | 测试起始时间 | 测试结束时间 |
| -------------------------------- | ------------ | ------------ |
| GCC 7.3.0                        | 2022-10-24   | 2022-10-29   |
| llvm-bolt:LLVM version 14.0.0git | 2022-11-15   | 2022-11-15   |

描述特性测试的硬件环境信息

| 硬件型号     | 硬件配置信息 | 备注                                             |
| ------------ | ------------ | ------------------------------------------------ |
| TaiShan 200  | 96U 512G     | aarch64 基础功能及反馈优化转项测试               |
| TaiShan 200K | 96U 256G     | aarch64 codedb测试专用                           |
| 虚拟机       | 4U 16G       | aarch64 反馈优化bolt-use模式mysql-8.0.20功能测试 |

描述特性测试的软件环境信息

| OS                        | 内核                                | 使用软件                                                     | 备注                               |
| ------------------------- | ----------------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| openEuler 21.09           | 5.10.0-5.10.0.24.oe1.aarch64 | perf:5.10.0-5.10.0.24.oe1.aarch64 llvm-bolt:0.20211016.gitb72f753.aarch64 | aarch64 基础功能及反馈优化转项测试 |
| openEuler 21.09           | 5.10.0-5.10.0.24.oe1.aarch64 |                                                              | aarch64 codedb测试专用             |
| openEuler 20.03 (LTS-SP1) | 4.19.90-2109.1.0.0108.oe1.aarch64 | perf:4.19.90-2109.1.0.0108.oe1.aarch64 llvm-bolt:0.20211016.gitb72f753.oe1.aarch64 | aarch64 反馈优化bolt-use模式mysql-8.0.20功能测试 |

# 3     测试结论概述

## 3.1   测试整体结论

GCC7.3.0编译器测试，转测二进制反馈优化bolt-use模式，主要覆盖基本功能测试，Fuzz测试，浮点精度测试，反馈优化专项测试。基本功能正常，遗留问题2个。

| 测试活动                     | 活动评价                                                     |
| ---------------------------- | ------------------------------------------------------------ |
| 基本功能测试                 | 执行测试套：dejanu、bstest、llvmcase、Anghabench、jotai、codeDB基本功能正常，无遗留问题； |
| 浮点精度测试                 | 执行测试套FPTEST，无新增FAIL用例；                           |
| Fuzz测试                     | csmith（c\c++浮点版本）、yarpgen（c\c++）等随机测试套件分别运行100w+用例，无遗留问题； |
| 反馈优化bolt-use模式专项测试 | 使用14个codedb应用结合A-FOT工具来验证反馈优化bolt-use特性功能，执行通过；                         使用冒泡排序测试反馈优化bolt-use特性功能，执行通过；                                                                     使用NPB应用（8种基准3种问题规模）测试反馈优化bolt-use 特性功能，遗留问题1个[I61FGB](https://gitee.com/src-openeuler/gcc/issues/I61FGB)；                          使用NPB应用并发24进程测试perf2bolt，执行通过；                                                                             使用MySQL 8.0.20测试反馈优化bolt-use特性功能，遗留问题1个[I61DOT](https://gitee.com/src-openeuler/gcc/issues/I61DOT) |



## 3.2  约束说明

无

## 3.3  问题分析
openEuler 20.03SP1 GCC7.3.0共发现问题2个，遗留问题2个。

### 3.3.1 遗留问题影响以及规避措施

| 序号 | 问题单号                                                    | 问题简述                                                     | 问题级别 | 影响分析                                                     | 规避措施                                                     |
| ---- | ----------------------------------------------------------- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | [I61DOT](https://gitee.com/src-openeuler/gcc/issues/I61DOT) | [20.03SP1] GCC7.3.0编译mysql-8.0.20失败                      | 次要     | 升级GCC版本时未同步升级glibc版本，会导致应用编译失败，不影响应用运行 | 升级glibc至2.28-66以后版本                                   |
| 2    | [I61FGB](https://gitee.com/src-openeuler/gcc/issues/I61FGB) | [20.03SP1]GCC7.3.0反馈优化bolt-use模式运行NPB应用生成的二进制报错：Program received signal SIGILL:Illegal instruction | 次要     | 开源llvm-bolt split function优化存在缺陷，可以通过关掉优化规避，可能导致性能提升降低 | 在编译时添加选项：-fbolt-option=-reorder-blocks=cache+,-reorder-functions=hfsort+,-split-all-cold,-dyno-stats,-icf=1,-use-gnu-stack |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 0    | 2    | 0      |
| 百分比 | 100%     | 0    | 0    | 100% | 0      |

### 3.3.3 问题列表

| 问题单号                                                    | 问题描述                                                     | 问题级别 | 当前状态 |
| ----------------------------------------------------------- | ------------------------------------------------------------ | -------- | -------- |
| [I61DOT](https://gitee.com/src-openeuler/gcc/issues/I61DOT) | [20.03SP1] GCC7.3.0编译mysql-8.0.20失败                      | 次要     | 待办的   |
| [I61FGB](https://gitee.com/src-openeuler/gcc/issues/I61FGB) | [20.03SP1]GCC7.3.0反馈优化bolt-use模式运行NPB应用生成的二进制报错：Program received signal SIGILL:Illegal instruction | 次要     | 待办的   |



# 4     测试执行

## 4.1   测试执行统计数据

*本节内容根据测试用例及实际执行情况进行特性整体测试的统计，可根据第二章的测试轮次分开进行统计说明。*

| 版本名称                         | 测试用例数 | 用例执行结果                                          | 发现问题单数 | 备注                                                         |
| -------------------------------- | ---------- | ----------------------------------------------------- | ------------ | ------------------------------------------------------------ |
| GCC 7.3.0                        | 200w+      | 除NPB部分基准反馈优化后二进制运行失败，其他测试项成功 | 1            | 200w+用例：                                                                           Fuzz测试csmith 100w+用例、yarpgen 100w+用例；冒泡排序用例1个；NPB应用（8种基准3种问题规模）；14个codedb应用结合A-FOT工具执行； |
| llvm-bolt:LLVM version 14.0.0git | 1          | 成功                                                  | 1            | 编译MySQL8.0.20出错'pthread_cond_clockwait'的实参不依赖模板参数。升级glibc至2.28-66以后版本规避。 |

*数据项说明：*

*测试用例数－－到本测试活动结束时，所有可用测试用例数；*

*发现问题单数－－本测试活动总共发现的问题单数。*

## 4.2   后续测试建议


# 5     附件

*无*